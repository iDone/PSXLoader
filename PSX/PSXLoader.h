//
//  PSXLoader.h
//  PSX
//
//  Created by Makigumo on 2016/12/11.
//    Copyright © 2016年 Makigumo. All rights reserved.
//

#import <Foundation/Foundation.h>
#import <Hopper/Hopper.h>

const char *const HEADER_MAGIC_PSX = "PS-X EXE";
const char *const HEADER_MAGIC_SCE = "SCE EXE";

typedef struct PSX_HEADER_PSX {
    char id[8];
    uint32_t reserved1;
    uint32_t reserved2;
    uint32_t pc0;
    uint32_t reserved3;
    uint32_t t_addr;
    uint32_t t_size;
    uint32_t reserved4;
    uint32_t reserved5;
    uint32_t reserved6;
    uint32_t reserved7;
    uint32_t s_addr;
    uint32_t s_size;
    uint32_t SavedSP;
    uint32_t SavedFP;
    uint32_t SavedGP;
    uint32_t SavedRA;
    uint32_t SavedS0;
} PsxHeader_PSX;

typedef struct PSX_HEADER_SCE {
    char id[8];
    uint32_t text;
    uint32_t data;
    uint32_t pc0;
    uint32_t gp0;
    uint32_t t_addr;
    uint32_t t_size;
    uint32_t d_addr;
    uint32_t d_size;
    uint32_t b_addr;
    uint32_t b_size;
    uint32_t s_addr;
    uint32_t s_size;
    uint32_t SavedSP;
    uint32_t SavedFP;
    uint32_t SavedGP;
    uint32_t SavedRA;
    uint32_t SavedS0;
} PsxHeader_SCE;

typedef struct {
    union {
        PsxHeader_PSX psx;
        PsxHeader_SCE sce;
    };
} PsxHeader;

typedef struct bioscall {
    uint8_t adr;
    uint8_t val;
    const char *const name;
} BIOS_CALL;

struct bioscall bios_calls[] = {
        {0xa0, 0x00, "open"},
        {0xa0, 0x01, "lseek"},
        {0xa0, 0x02, "read"},
        {0xa0, 0x03, "write"},
        {0xa0, 0x04, "close"},
        {0xa0, 0x05, "ioctl"},
        {0xa0, 0x06, "exit"},
        {0xa0, 0x07, "sys_b0_39"},
        {0xa0, 0x08, "getc"},
        {0xa0, 0x09, "putc"},
        {0xa0, 0x0a, "todigit"},
        {0xa0, 0x0b, "atof"},
        {0xa0, 0x0c, "strtoul"},
        {0xa0, 0x0d, "strtol"},
        {0xa0, 0x0e, "abs"},
        {0xa0, 0x0f, "labs"},
        {0xa0, 0x10, "atoi"},
        {0xa0, 0x11, "atol"},
        {0xa0, 0x12, "atob"},
        {0xa0, 0x13, "setjmp"},
        {0xa0, 0x14, "longjmp"},
        {0xa0, 0x15, "strcat"},
        {0xa0, 0x16, "stncat"},
        {0xa0, 0x17, "strcmp"},
        {0xa0, 0x18, "strncmp"},
        {0xa0, 0x19, "strcpy"},
        {0xa0, 0x1a, "strncpy"},
        {0xa0, 0x1b, "strlen"},
        {0xa0, 0x1c, "index"},
        {0xa0, 0x1d, "rindex"},
        {0xa0, 0x1e, "strchr"},
        {0xa0, 0x1f, "strrchr"},
        {0xa0, 0x20, "strpbrk"},
        {0xa0, 0x21, "strspn"},
        {0xa0, 0x22, "strcspn"},
        {0xa0, 0x23, "strtok"},
        {0xa0, 0x24, "strstr"},
        {0xa0, 0x25, "toupper"},
        {0xa0, 0x26, "tolower"},
        {0xa0, 0x27, "bcopy"},
        {0xa0, 0x28, "bzero"},
        {0xa0, 0x29, "bcmp"},
        {0xa0, 0x2a, "memcpy"},
        {0xa0, 0x2b, "memset"},
        {0xa0, 0x2c, "memmove"},
        {0xa0, 0x2d, "memcmp"},
        {0xa0, 0x2e, "memchr"},
        {0xa0, 0x2f, "rand"},
        {0xa0, 0x30, "srand"},
        {0xa0, 0x31, "qsort"},
        {0xa0, 0x32, "strtod"},
        {0xa0, 0x33, "malloc"},
        {0xa0, 0x34, "free"},
        {0xa0, 0x35, "lsearch"},
        {0xa0, 0x36, "bsearch"},
        {0xa0, 0x37, "calloc"},
        {0xa0, 0x38, "realloc"},
        {0xa0, 0x39, "InitHeap"},
        {0xa0, 0x3a, "_exit"},
        {0xa0, 0x3b, "getchar"},
        {0xa0, 0x3c, "putchar"},
        {0xa0, 0x3d, "gets"},
        {0xa0, 0x3e, "puts"},
        {0xa0, 0x3f, "printf"},
        //{0xa0, 0x40, ""},
        {0xa0, 0x41, "LoadTest"},
        {0xa0, 0x42, "Load"},
        {0xa0, 0x43, "Exec"},
        {0xa0, 0x44, "FlushCache"},
        {0xa0, 0x45, "InstallInterruptHandler"},
        {0xa0, 0x46, "GPU_dw"},
        //{0xa0, 0x47, ""},
        {0xa0, 0x48, "SetGPUStatus"},
        {0xa0, 0x49, "GPU_cw"},
        {0xa0, 0x4a, "GPU_cwb"},
        //{0xa0, 0x4b, ""},
        //{0xa0, 0x4c, ""},
        {0xa0, 0x4d, "GetGPUStatus"},
        //{0xa0, 0x4e, ""},
        //{0xa0, 0x4f, ""},
        //{0xa0, 0x50, ""},
        {0xa0, 0x51, "LoadExec"},
        {0xa0, 0x52, "GetSysSp"},
        //{0xa0, 0x53, ""},
        {0xa0, 0x54, "_96_init"},
        {0xa0, 0x55, "_bu_init"},
        {0xa0, 0x56, "_96_remove"},
        {0xa0, 0x57, "return0_1"},
        {0xa0, 0x58, "return0_2"},
        {0xa0, 0x59, "return0_3"},
        {0xa0, 0x5a, "return0_4"},
        {0xa0, 0x5b, "dev_tty_init"},
        {0xa0, 0x5c, "dev_tty_open"},
        //{0xa0, 0x5d, ""},
        {0xa0, 0x5e, "dev_tty_ioctl"},
        {0xa0, 0x5f, "dev_cd_open"},
        {0xa0, 0x60, "dev_cd_read"},
        {0xa0, 0x61, "dev_cd_close"},
        {0xa0, 0x62, "dev_cd_firstfile"},
        {0xa0, 0x63, "dev_cd_nextfile"},
        {0xa0, 0x64, "dev_cd_chdir"},
        {0xa0, 0x65, "dev_card_open"},
        {0xa0, 0x66, "dev_card_read"},
        {0xa0, 0x67, "dev_card_write"},
        {0xa0, 0x68, "dev_card_close"},
        {0xa0, 0x69, "dev_card_firstfile"},
        {0xa0, 0x6a, "dev_card_nextfile"},
        {0xa0, 0x6b, "dev_card_erase"},
        {0xa0, 0x6c, "dev_card_undelete"},
        {0xa0, 0x6d, "dev_card_format"},
        {0xa0, 0x6e, "dev_card_rename"},
        //{0xa0, 0x6f, ""},
        {0xa0, 0x70, "_bu_init"},
        {0xa0, 0x71, "_96_init"},
        {0xa0, 0x72, "_96_remove"},
        //{0xa0, 0x73, ""},
        //{0xa0, 0x74, ""},
        //{0xa0, 0x75, ""},
        //{0xa0, 0x76, ""},
        //{0xa0, 0x77, ""},
        {0xa0, 0x78, "_96_CdSeekL"},
        //{0xa0, 0x79, ""},
        //{0xa0, 0x7a, ""},
        //{0xa0, 0x7b, ""},
        {0xa0, 0x7c, "_96_CdGetStatus"},
        //{0xa0, 0x7d, ""},
        {0xa0, 0x7e, "_96_CdRead"},
        //{0xa0, 0x7f, ""},
        //{0xa0, 0x80, ""},
        //{0xa0, 0x81, ""},
        //{0xa0, 0x82, ""},
        //{0xa0, 0x83, ""},
        //{0xa0, 0x84, ""},
        {0xa0, 0x85, "_96_CdStop"},
        //{0xa0, 0x86, ""},
        //{0xa0, 0x87, ""},
        //{0xa0, 0x88, ""},
        //{0xa0, 0x89, ""},
        //{0xa0, 0x8a, ""},
        //{0xa0, 0x8b, ""},
        //{0xa0, 0x8c, ""},
        //{0xa0, 0x8d, ""},
        //{0xa0, 0x8e, ""},
        //{0xa0, 0x8f, ""},
        //{0xa0, 0x90, ""},
        //{0xa0, 0x91, ""},
        //{0xa0, 0x92, ""},
        //{0xa0, 0x93, ""},
        //{0xa0, 0x94, ""},
        //{0xa0, 0x95, ""},
        {0xa0, 0x96, "AddCDROMDevice"},
        {0xa0, 0x97, "AddMemCardDevice"},
        {0xa0, 0x98, "DisableKernelIORedirection"},
        {0xa0, 0x99, "EnableKernelIORedirection"},
        //{0xa0, 0x9a, ""},
        //{0xa0, 0x9b, ""},
        {0xa0, 0x9c, "GetConf1"},
        {0xa0, 0x9d, "GetConf2"},
        //{0xa0, 0x9e, ""},
        {0xa0, 0x9f, "SetMem"},
        {0xa0, 0xa0, "_boot"},
        {0xa0, 0xa1, "SystemError"},
        {0xa0, 0xa2, "EnqueueCdIntr"},
        {0xa0, 0xa3, "DequeueCdIntr"},
        //{0xa0, 0xa4, ""},
        {0xa0, 0xa5, "ReadSector"},
        {0xa0, 0xa6, "get_cd_status"},
        {0xa0, 0xa7, "bufs_cb_0"},
        {0xa0, 0xa8, "bufs_cb_1"},
        {0xa0, 0xa9, "bufs_cb_2"},
        {0xa0, 0xaa, "bufs_cb_3"},
        {0xa0, 0xab, "_card_info"},
        {0xa0, 0xac, "_card_load"},
        {0xa0, 0xad, "_card_auto"},
        {0xa0, 0xae, "bufs_cb_4"},
        //{0xa0, 0xaf, ""},
        //{0xa0, 0xb0, ""},
        //{0xa0, 0xb1, ""},
        {0xa0, 0xb2, "do_long_jmp"},
        //{0xa0, 0xb3, ""},
        {0xa0, 0xb4, "multiple"},


        {0xb0, 0x01, "SysMalloc"},
        //{0xb0, 0x02, ""},
        //{0xb0, 0x03, ""},
        //{0xb0, 0x04, ""},
        //{0xb0, 0x05, ""},
        //{0xb0, 0x06, ""},
        {0xb0, 0x07, "DeliverEvent"},
        {0xb0, 0x08, "OpenEvent"},
        {0xb0, 0x09, "CloseEvent"},
        {0xb0, 0x0a, "WaitEvent"},
        {0xb0, 0x0b, "TestEvent"},
        {0xb0, 0x0c, "EnableEvent"},
        {0xb0, 0x0d, "DisableEvent"},
        {0xb0, 0x0e, "OpenTh"},
        {0xb0, 0x0f, "CloseTh"},
        {0xb0, 0x10, "ChangeTh"},
        //{0xb0, 0x11, ""},
        {0xb0, 0x12, "InitPad"},
        {0xb0, 0x13, "StartPad"},
        {0xb0, 0x14, "StopPad"},
        {0xb0, 0x15, "PAD_init"},
        {0xb0, 0x16, "PAD_dr"},
        {0xb0, 0x17, "ReturnFromException"},
        {0xb0, 0x18, "ResetEntryInt"},
        {0xb0, 0x19, "HookEntryInt"},
        //{0xb0, 0x1a, ""},
        //{0xb0, 0x1b, ""},
        //{0xb0, 0x1c, ""},
        //{0xb0, 0x1d, ""},
        //{0xb0, 0x1e, ""},
        //{0xb0, 0x1f, ""},
        {0xb0, 0x20, "UnDeliverEvent"},
        //
        //{0xb0, 0x30, ""},
        //{0xb0, 0x31, ""},
        {0xb0, 0x32, "open"},
        {0xb0, 0x33, "lseek"},
        {0xb0, 0x34, "read"},
        {0xb0, 0x35, "write"},
        {0xb0, 0x36, "close"},
        {0xb0, 0x37, "ioctl"},
        {0xb0, 0x38, "exit"},
        //{0xb0, 0x39, ""},
        {0xb0, 0x3a, "get"},
        {0xb0, 0x3b, "putc"},
        {0xb0, 0x3c, "getchar"},
        {0xb0, 0x3d, "putchar"},
        {0xb0, 0x3e, "gets"},
        {0xb0, 0x3f, "puts"},
        {0xb0, 0x40, "cd"},
        {0xb0, 0x41, "format"},
        {0xb0, 0x42, "firstfile"},
        {0xb0, 0x43, "nextfile"},
        {0xb0, 0x44, "rename"},
        {0xb0, 0x45, "delete"},
        {0xb0, 0x46, "undelete"},
        {0xb0, 0x47, "AddDevice"},
        {0xb0, 0x48, "RemoveDevice"},
        {0xb0, 0x49, "PrintInstalledDevices"},
        {0xb0, 0x4a, "InitCARD"},
        {0xb0, 0x4b, "StartCARD"},
        {0xb0, 0x4c, "StopCARD"},
        //{0xb0, 0x4d, ""},
        {0xb0, 0x4e, "_card_write"},
        {0xb0, 0x4f, "_card_read"},
        {0xb0, 0x50, "_new_card"},
        {0xb0, 0x51, "Krom2RawAdd"},
        //{0xb0, 0x52, ""},
        //{0xb0, 0x53, ""},
        {0xb0, 0x54, "_get_errno"},
        {0xb0, 0x55, "_get_error"},
        {0xb0, 0x56, "GetC0Table"},
        {0xb0, 0x57, "GetB0Table"},
        {0xb0, 0x58, "_card_chan"},
        //{0xb0, 0x59, ""},
        //{0xb0, 0x5a, ""},
        {0xb0, 0x5b, "ChangeClearPad"},
        {0xb0, 0x5c, "_card_status"},
        {0xb0, 0x5d, "_card_wait"},
        //{0xb0, 0x5e, ""},
        //{0xb0, 0x5f, ""},


        {0xc0, 0x00, "InitRCnt"},
        {0xc0, 0x01, "InitException"},
        {0xc0, 0x02, "SysEnqIntRP"},
        {0xc0, 0x03, "SysDeqIntRP"},
        {0xc0, 0x04, "get_free_EvCB_slot"},
        {0xc0, 0x05, "get_free_TCB_slot"},
        {0xc0, 0x06, "ExceptionHandler"},
        {0xc0, 0x07, "InstallExceptionHandlers"},
        {0xc0, 0x08, "SysInitMemory"},
        {0xc0, 0x09, "SysInitKMem"},
        {0xc0, 0x0a, "ChangeClearRCnt"},
        {0xc0, 0x0b, "SystemError"},
        {0xc0, 0x0c, "InitDefInt"},
        //{0xc0, 0x0d, ""},
        //{0xc0, 0x0e, ""},
        //{0xc0, 0x0f, ""},
        //{0xc0, 0x10, ""},
        //{0xc0, 0x11, ""},
        {0xc0, 0x12, "InstallDevices"},
        {0xc0, 0x13, "FlushStdInOutPut"},
        {0xc0, 0x14, "return0_5"},
        {0xc0, 0x15, "_cdevinput"},
        {0xc0, 0x16, "_cdevscan"},
        {0xc0, 0x17, "_circget"},
        {0xc0, 0x18, "_circput"},
        {0xc0, 0x19, "ioabort"},
        //{0xc0, 0x1a, ""},
        {0xc0, 0x1b, "KernelRedirect"},
        {0xc0, 0x1c, "PatchA0table"},
};

@interface PSXLoader : NSObject <FileLoader>

@end
